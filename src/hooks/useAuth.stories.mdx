import { useState, useMemo, useEffect } from 'react'
import { Address } from 'web3x/address'
import { Personal } from 'web3x/personal'
import { LegacyProviderAdapter } from 'web3x/providers'
import { Source, ArgsTable } from '@storybook/components';
import { Meta, Story, Preview } from '@storybook/addon-docs/blocks';
import { ChainId } from "@dcl/schemas"
import { ProviderType } from "decentraland-connect/dist/types"
import Grid from "semantic-ui-react/dist/commonjs/collections/Grid/Grid"
import { Button } from 'decentraland-ui/dist/components/Button/Button';
import { Args } from '../components/Storybook/utils';
import Container from '../components/Storybook/Container';
import Textarea from '../components/Form/Textarea';
import useAuth from './useAuth';

<Meta title="Standalone Hooks/useAuth" />

# Auth Hook

> The *auth hook* allows to create a user session using one of the availables providers.

```ts
const [ account, state ] = useAuth()
```

<ArgsTable rows={[
  Args.returns('account', 'ethereum address ', `string | null`),
  Args.returns('state.loading', '`true` when is waiting for a user initeraction', `boolean`),
  Args.returns('state.selecting', '`true` when is showing the wallet selector modal', `boolean`),
  Args.returns(
    'state.providerType',
    'type of provider conneceted to, `null` if not connected. \n\n imported from [decentraland-connect](https://www.npmjs.com/package/decentraland-connect)',
    Args.definedTypes(
      `ProviderType | null`,
      [
        'ProviderType.INJECTED',
        'ProviderType.FORTMATIC',
        null
      ]
    )
  ),
  Args.returns(
    'state.chainId',
    'chain id connected to, `null` if not connected. \n\n imported from [decentraland-connect](https://www.npmjs.com/package/decentraland-connect)',
    Args.definedTypes(
      `ChainId | null`,
      [
        'ChainId.ETHEREUM_MAINNET',
        'ChainId.ETHEREUM_ROPSTEN',
        'ChainId.ETHEREUM_RINKEBY',
        'ChainId.ETHEREUM_GOERLI',
        'ChainId.ETHEREUM_KOVAN',
        'ChainId.MATIC_MUMBAI',
        'ChainId.MATIC_MAINNET',
        null
      ]
    )
  ),
  {/* Args.returns('clipboard.copy', 'send value to the user clipboard', `(value: boolean | number | string) => void`),
  Args.returns('clipboard.clear', 'reset clipboard value to `null`', `() => void`), */}
]} />

## Connect Preview

export const Example = () => {
  const [ account, state ] = useAuth()
  return <Container>
    <Button primary size="small" disabled={!!account} loading={state.loading} onClick={() => state.connect(ProviderType.INJECTED, ChainId.ETHEREUM_MAINNET)}>connect injected</Button>
    <Button primary size="small" disabled={!!account} loading={state.loading} onClick={() => state.connect(ProviderType.FORTMATIC, ChainId.ETHEREUM_MAINNET)}>connect fortmatic</Button>
    {/* <Button primary size="small" disabled={true} loading={state.loading} onClick={() => null}>connect wallet connect</Button> */}
    {/* <Button primary size="small" disabled={true} loading={state.loading} onClick={() => null}>connect wallet link</Button> */}
    <Button primary size="small" disabled={!account} loading={state.loading} onClick={() => state.disconnect()}>disconnect</Button>
    <Source language="ts" code={JSON.stringify(account, null, 2)} />
    <Source language="ts" code={JSON.stringify({
      loading: state.loading,
      providerType: state.providerType,
      chainId: state.chainId,
    }, null, 2)} />
  </Container>
}

<Example />

```tsx dark=true
import React from "react"
import { ProviderType, ChainId } from "decentraland-connect/dist/types"

export function Example () {
  const [ account, state ] = useAuth()

  return <div>
    <button disabled={!!account} loading={state.loading} onClick={() => state.connect(ProviderType.INJECTED, ChainId.ETHEREUM_MAINNET)}>connect injected</button>
    <button disabled={!!account} loading={state.loading} onClick={() => state.connect(ProviderType.FORTMATIC, ChainId.ETHEREUM_MAINNET)}>connect fortmatic</button>
    <button disabled={!account} loading={state.loading} onClick={() => state.disconnect()}>disconnect</button>
    <pre>{JSON.stringify(account, null, 2)}</pre>
  </div>
}
```

## Using the connected provider

export const Sign = () => {
  const [ account, accountState ] = useAuth()
  const [ state, setState ] = useState({
    message: 'This a the origina messsage',
    signature: '',
    signing: false,
  })
  useEffect(() => {
    if (state.signing) {
      new Personal(accountState.provider)
        .sign(state.message, Address.fromString(account), '')
        .then((signature) => {
          console.log(signature)
          setState((current) => ({ ...current, signature, signing: false }))
        })
        .catch((err) => {
          console.error(err)
          setState((current) => ({ ...current, signing: false }))
        })
    }
  }, [ state.signing ])
  return <Container>
    <Grid>
      <Grid.Row>
        <Grid.Column tablet="8">
          <Textarea value={state.message} minHeight={170} onChange={(e, { value }) => setState((current) => ({ ...current, message: value })) } />
        </Grid.Column>
        <Grid.Column tablet="8">
          <Button primary size="small" style={{ minWidth: '200px', margin: '0 auto' }} disabled={!account} loading={state.signing} onClick={() => setState((current) => ({ ...current, signing: true }))}>Sign</Button>
          <Source language="ts" code={JSON.stringify(state.signature, null, 2)} />
        </Grid.Column>
      </Grid.Row>
    </Grid>
  </Container>
}

<Sign />

```tsx dark=true
import React from "react"
import { Address } from 'web3x/address'
import { Personal } from 'web3x/personal'
import { ProviderType, ChainId } from "decentraland-connect/dist/types"

export function Sign () {
  const [ address, state ] = useAuth()
  const [ message, setMessage ] = useState('This a the origina messsage')
  const [ signature, setSignature ] = useState('')
  function handleSignature() {
    new Personal(state.provider)
        .sign(message, Address.fromString(address), '')
        .then((signature) => setSignature(signature))
  }

  return <div>
    <textarea value={message} onChange={(e) => setMessage(e.currentTarget.value)}></textarea>
    <button disabled={!account} onClick={handleSignature}>sign</button>
    <pre>{JSON.stringify(signature, null, 2)}</pre>
  </div>
}
```
